function calcularEneatipoYala() {
    const hojaRespuestas = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Respuestas de formulario 1");
    const hojaMapa = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Mapa");
  
    const respuestas = hojaRespuestas.getDataRange().getValues();
    const encabezados = respuestas[0].slice(1); // sin timestamp
    const mapa = hojaMapa.getDataRange().getValues();
  
    const preguntaAEneatipo = {};
    for (let i = 1; i < mapa.length; i++) {
      const texto = mapa[i][0];
  
      // Verifica si el valor es una cadena antes de intentar usar .trim()
      if (typeof texto === 'string') {
        const textoLimpio = texto.trim(); // Limpiar espacios en blanco al inicio y final
        const eneatipo = parseInt(mapa[i][1]);
        preguntaAEneatipo[textoLimpio] = eneatipo;
      } else {
        // Si no es una cadena, registra un mensaje de advertencia
        Logger.log(`Pregunta no válida en la fila ${i + 1}: ${mapa[i][0]}`);
      }
    }
  
    const valores = {
      "Casi nunca": 1,
      "Rara vez": 2,
      "Algo cierto": 3,
      "Generalmente cierto": 4,
      "Muy cierto": 5
    };
  
    const columnasExtras = ["Eneatipo", "Ala", "Puntajes"];
    const ultimaColumna = respuestas[0].length;
  
    // Agregar encabezados nuevos si no existen
    const nuevasColumnas = respuestas[0].slice(-3);
    if (JSON.stringify(nuevasColumnas) !== JSON.stringify(columnasExtras)) {
      hojaRespuestas.getRange(1, ultimaColumna + 1, 1, 3).setValues([columnasExtras]);
    }
  
    for (let i = 1; i < respuestas.length; i++) {
      const fila = respuestas[i];
      const puntajes = Array(10).fill(0); // índice 1–9
  
      for (let j = 1; j < fila.length && j - 1 < encabezados.length; j++) {
        const respuestaTexto = fila[j];
        const preguntaTexto = encabezados[j - 1];
        const eneatipo = preguntaAEneatipo[preguntaTexto];
  
        if (eneatipo && valores[respuestaTexto]) {
          puntajes[eneatipo] += valores[respuestaTexto];
        }
      }
  
      // Calcular eneatipo dominante
      let maxPuntaje = 0;
      let tipoPrincipal = 0;
      for (let t = 1; t <= 9; t++) {
        if (puntajes[t] > maxPuntaje) {
          maxPuntaje = puntajes[t];
          tipoPrincipal = t;
        }
      }
  
      // Calcular ala
      const ala1 = tipoPrincipal === 1 ? 9 : tipoPrincipal - 1;
      const ala2 = tipoPrincipal === 9 ? 1 : tipoPrincipal + 1;
      const ala = puntajes[ala1] > puntajes[ala2] ? ala1 : ala2;
  
      hojaRespuestas.getRange(i + 1, ultimaColumna + 1, 1, 3).setValues([[ 
        tipoPrincipal,
        ala,
        JSON.stringify(puntajes.slice(1))
      ]]);
    }
  
    SpreadsheetApp.getUi().alert("✅ Cálculo completado. Eneatipo y ala añadidos.");
  }